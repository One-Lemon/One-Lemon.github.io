---
title: 小程序奇葩坑点
date: 2020年5月16日12:10:13
tags: [微信小程序,JavaScript]
categories: 微信小程序
toc: true
mathjax: true
---

# 小程序坑点总结

## 背景故事

> 可怜的我在产品的逼迫下，要在PC微信和PC企业微信都能完美运行小程序。四月份的时候，PC微信有了小程序面板，然后我就开始了写bug之路。
>

## PC微信小程序没有首页按钮

> 小程序在使用的时候，会根据判断路由信息是否为空，如果为空，会在导航栏自动生成一个首页的按钮。在PC微信中，小程序并不会去根据路由信息判断，

触发场景：

- 当你使用`wx.reLaunch`或者`wx.redirectTo`使得当前路由为空的时候，并不会出现回到首页的按钮。
- 直接跳到非首页路由页面

解决方法：

- 非首页页面添加侧边快捷操作按钮，这个可以作为一个组件，不过相对比较麻烦，而且会遮挡页面内容
- 使用自定义导航栏，好用，但是部分场景会引发的Bug就比较扎心了，自定义导航栏另外介绍。

## 上传图片无效

> 小程序上传文件我们使用`wx.uploadFile`，然后我在官方文档看到这么一句话。
>
>  将本地资源上传到服务器。客户端发起一个 HTTPS POST 请求，其中 `content-type` 为 `multipart/form-data`。 
>
> PS：正是因为这一句话，引发了我这次寻Bug之旅，企业微信联系了小程序官方问这个问题，他们表示没复现出来。

触发场景：

- `wx.uploadFile`中添加了`content-type: multipart/form-data`
- 在PC微信或者PC企业微信中运行小程序进行上传图片

解决方法：

- 去掉`content-type: multipart/form-data`

## PC端运行小程序

企业微信

- 企业微信暂只支持运行正式版小程序，不能唤起体验版，包括分享体验版也是无法使用

微信

- 可以使用所有版本的小程序

Tips：如果你要在PC微信运行开发版，通常有这几种方法

- 截图二维码发在微信上，微信现在可以扫描图片二维码
- 在微信开发者工具中打开通用设置 -> 启动PC端自动预览

## 微信开发者工具反复横跳

> 某些场景下我们可能需要手动操作返回，比如使用`wx.navigateBack`，然后在使用小程序自带的返回键会在两个页面来回跳动

触发场景：

- 部分页面自定义导航栏
- 仅仅出现在微信开发者工具上面

解决方法：

- 无视。。。因为，实际用起来并不会这样，只是在开发者工具上会这样，很奇怪
- 全部使用自定义导航栏

## PC小程序不支持`chooseMessageFile`

> 现在的小程序可以通过`wx.chooseMessageFile`去选择图片以外的各种格式的文件。辣么，问题来了，在PC上会提示`chooseMessageFile:fail:not supported`。在`Ststem`中你会发现版本号明明比这个`API`高呀。但是还是会这样，企业微信上联系了小程序助手，emm，暂时无解。

## 页面底部的`input`框在输入时会把自定义导航栏挤掉

> 自定义导航栏也算页面内容，所以也是会被强制位移

触发场景：

- 自定义导航栏 && 页面底部有输入框

解决方法：

- 尽量避免在页面底部出现输入框

- 监听文本框` bindblur   bindfocus `事件，在聚焦时候动态改变页面的`padding-bottom`

   `event.detail = { value, height }，height 为键盘高度 `

-  设置 `input` 的 `adjust-position` 为 `false`，不自动上推，用 `wx.pageScrollTo` 来自定义上推行为 

